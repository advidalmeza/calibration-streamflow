---
title: 'Assignment 5: Model Performance Evaluation'
author: 'Lewis White, Jessica French, Alessandra Vidal Meza'
date: '`r Sys.Date()`'
output: html_document
---

# Metric Function: highflowmetrics()
Explain why we choose months, annual maximum, and annual max correlation, high month error, and high month correlation, and why high flow matters

# Application
## Setting up Environment
```{r setup, echo = FALSE}
# Load packages
library(here)
library(sensitivity)
library(tidyverse)
library(lubridate)
library(reldist)
library(purrr)
library(ggpubr)

# Source nse() function 
source(here::here("R", "nse.R"))

# Source relerr() function for relative error
source(here::here("R", "relerr.R"))

# Source combined performance calculating function for NSE and relative error with 50/50 weighting 
source(here::here("R", "cper.R"))

# Source highflowmetrics() function
source(here::here("R", "highflowmetrics.R"))

# Read data frames
sager <- read.table(here::here('Data', 'sager.txt'), header = T)
msage <- read.table(here::here('Data', 'sagerm.txt'), header = T) 
```

### Data Pre-Processing
```{r}
sager <- sager %>% 
  mutate(date = paste(day, month, year, sep = '/')) %>%
  mutate(date = as.Date(date,'%d/%m/%Y'))

# pivot longer
sagerl <- sager %>% 
  pivot_longer(cols = c("model","obs"),
               names_to = "source",
               values_to = "flow")

# Set different time step
sager_wy <- sager %>% 
  group_by(wy) %>% 
  summarize(model = sum(model), obs = sum(obs))

# Sum by month
tmp <- sager %>% 
  group_by(wy, month) %>% 
  summarize(model = sum(model), obs = sum(obs))
```

```{r message = FALSE}
nsim <- ncol(msage)
snames <- sprintf("S%d", seq(from = 1, to = nsim))
colnames(msage) <- snames

# lets say we know the start date from our earlier output
msage$date <- sager$date
msage$month <- sager$month
msage$year <- sager$year
msage$day <- sager$day
msage$wy <- sager$wy

# lets add observed
msage <- left_join(msage, sager[,c("obs","date")], by = c("date"))

# how can we plot all results - lets plot water year 1970 otherwise its hard to see
msagel <- msage %>% 
  pivot_longer(cols = !c(date, month, year, day, wy), 
               names_to = "run", 
               values_to = "flow")

short_msage <- subset(msage, wy < 1975)
```

## Apply highflowmetrics() function
```{r}
res <- short_msage %>% 
  select(-date, -month, -day, -year, -wy, -obs) %>%
  map_df(compute_highflowmetrics, o = short_msage$obs,
         month = short_msage$month, day = short_msage$day, 
         year = short_msage$year, wy = short_msage$wy)

res$sim <- snames

# graph range of performance measures
resl <- res %>% 
  pivot_longer(-sim, names_to = "metric", values_to = "value")

# Select the best and worst based on the combined metric
best <- res[which.max(res$combined),]
worst <- res[which.min(res$combined),]
 
compruns <- msage %>% 
  select(best$sim, worst$sim, date, obs, month, day, year, wy)

compruns <- subset(compruns, wy > 1970)

compruns_mwy <- compruns %>% 
   select(-c(day,date, year)) %>% 
   group_by(month, wy) %>% 
   summarize(across(everything(), mean))

compruns_mwyl <- compruns_mwy %>% 
  pivot_longer(cols = !c(month, wy), names_to = "sim", values_to = "flow")
```

## Visualization

```{r multiple}

p1 <- ggplot(subset(msagel, wy == 1970), 
            aes(as.Date(date), flow, col = run)) + 
  geom_line() + 
  theme(legend.position = "none")

p1

p1 + 
  geom_line(data = subset(sager, wy == 1970), 
            aes(as.Date(date), obs), 
            size = 2, col = "black", linetype = 2) + 
  labs(y = "Streamflow", x = "Date")

ggplot(resl, aes(metric, value)) + 
  geom_boxplot() + 
  facet_wrap(~metric, scales = "free")

 ggplot(msage, aes(date, msage[,best$sim])) + 
   geom_line() + 
   geom_line(aes(date, obs), col = "red") 

 compruns_mwyl %>% 
   subset(month %in% c(12, 1, 2)) %>% 
   ggplot(aes(sim, flow)) + 
   geom_boxplot()
```

```{r}
ggplot(resl, aes(metric, value)) + 
  geom_boxplot() + 
  facet_wrap(~metric, scales = "free")
```

```{r}
# lets start with streamflow estimates from best performing parameter set
 ggplot(msage, aes(date, msage[,best$sim])) + 
   geom_line() + 
   geom_line(aes(date, obs), col = "red") 

```

```{r}
 compruns_mwyl %>% 
   subset(month %in% c(12, 1, 2)) %>% 
   ggplot(aes(sim, flow)) + 
   geom_boxplot()
```

## Discussion 
A short paragraph discussing why you choose the output and performance measures that you did and some thoughts (1-2 sentences) on what your calibration and post-calibration uncertainty analysis tells you


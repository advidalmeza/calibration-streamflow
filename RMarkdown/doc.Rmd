---
title: 'Assignment 5: Model Performance Evaluation'
author: 'Lewis White, Jessica French, Alessandra Vidal Meza'
date: '`r Sys.Date()`'
output: html_document
---

# Metric Function: highflowmetrics()
Explain why we choose months, annual maximum, and annual max correlation, high month error, and high month correlation, and why high flow matters

# Application
## Setting up Environment
```{r setup, message = FALSE, warning = FALSE}
# Load packages
library(here)
library(sensitivity)
library(tidyverse)
library(lubridate)
library(reldist)
library(purrr)
library(ggpubr)
library(patchwork)

# Source nse() function 
source(here::here("R", "nse.R"))

# Source relerr() function for relative error
source(here::here("R", "relerr.R"))

# Source combined performance calculating function for NSE and relative error with 50/50 weighting 
source(here::here("R", "cper.R"))

# Source highflowmetrics() function
source(here::here("R", "highflowmetrics.R"))

# Read data frames
sager <- read.table(here::here('Data', 'sager.txt'), header = T)
msage <- read.table(here::here('Data', 'sagerm.txt'), header = T) 
```

### Data Pre-Processing
```{r, message = FALSE, warning = FALSE}
#Single prodiction dataset
sager <- sager %>% 
  mutate(date = paste(day, month, year, sep = '/')) %>%
  mutate(date = as.Date(date,'%d/%m/%Y'))

# pivot longer
sagerl <- sager %>% 
  pivot_longer(cols = c("model","obs"),
               names_to = "source",
               values_to = "flow")

# Set different time step
sager_wy <- sager %>% 
  group_by(wy) %>% 
  summarize(model = sum(model), obs = sum(obs))

# Sum by month
tmp <- sager %>% 
  group_by(wy, month) %>% 
  summarize(model = sum(model), obs = sum(obs))
```

```{r message = FALSE, warning=FALSE}
#101 simulations dataset 
nsim <- ncol(msage)
snames <- sprintf("S%d", seq(from = 1, to = nsim))
colnames(msage) <- snames

# lets say we know the start date from our earlier output
msage$date <- sager$date
msage$month <- sager$month
msage$year <- sager$year
msage$day <- sager$day
msage$wy <- sager$wy

# lets add observed
msage <- left_join(msage, sager[,c("obs","date")], by = c("date"))

# how can we plot all results - lets plot water year 1970 otherwise its hard to see
msagel <- msage %>% 
  pivot_longer(cols = !c(date, month, year, day, wy), 
               names_to = "run", 
               values_to = "flow")

short_msage <- subset(msage, wy < 1975)
```

## Apply highflowmetrics() function
```{r, message = FALSE, warning = FALSE}
#apply highflowmetrics() function to all simulations in msage, only for water years before 1975
res <- short_msage %>% 
  select(-date, -month, -day, -year, -wy, -obs) %>%
  map_df(compute_highflowmetrics, o = short_msage$obs,
         month = short_msage$month, day = short_msage$day, 
         year = short_msage$year, wy = short_msage$wy)

#add simulation names as a new column
res$sim <- snames

# prepare data to graph range of performance measures
resl <- res %>% 
  pivot_longer(-sim, names_to = "metric", values_to = "value")

# Select the best and worst based on the combined metric
best <- res[which.max(res$combined),] #S89
worst <- res[which.min(res$combined),] #S15
 
compruns <- msage %>% 
  select(best$sim, worst$sim, date, obs, month, day, year, wy)

compruns <- subset(compruns, wy > 1970)

compruns_mwy <- compruns %>% 
   select(-c(day,date, year)) %>% 
   group_by(month, wy) %>% 
   summarize(across(everything(), mean))

compruns_mwyl <- compruns_mwy %>% 
  pivot_longer(cols = !c(month, wy), names_to = "sim", values_to = "flow")
```

## Visualization

```{r multiple, message = FALSE, warning = FALSE}
#Graphing a time series of the streamflow ~ predictions + observed
p1 <- ggplot(subset(msagel, wy == 1970), 
            aes(as.Date(date), flow, col = run)) + 
  geom_line() + 
  theme_minimal() +
  theme(legend.position = "none")

p1 + 
  geom_line(data = subset(sager, wy == 1970), 
            aes(as.Date(date), obs), 
            size = 1.5, col = "black", linetype = 2) + 
  labs(y = "Streamflow (cubic feet per second)", 
       x = "Date", 
       title = "Graphing simulations of streamflow predictions along with the true observed values")


# Creating boxplots to compare the true measured values to the best and worst simulations

annual_plot <- compruns_mwyl %>%
   ggplot(aes(sim, flow)) + 
   geom_boxplot() +
  theme_minimal() +
  labs(x = "Simulation",
       y = "Streamflow (cubic feet per second",
       title = "For annual values, there is \n not much difference between \n the best and worst simulations")


may_plot <- compruns_mwyl %>% 
   subset(month %in% c(5)) %>% 
   ggplot(aes(sim, flow)) + 
   geom_boxplot() +
  theme_minimal() +
  labs(x = "Simulation",
       y = "Streamflow (cubic feet per second",
       title = "The best simulation matched \n the true observations much closer \n in May, the peak stremflow month")

annual_plot + may_plot


#Plot to compare best simulation to the observed values 
 ggplot(msage, aes(date, log(msage[,best$sim]))) + 
   geom_line() + 
   geom_line(aes(date, log(obs)), col = "red") +
   theme_minimal() +
   labs(x = "Date",
        y = "Logged Streamflow",
        title = "Comparing the best simulation to the true observed values",
        subtitle = "The log of the streamflow was used to better compare low steamflow values")

 
 
##Code to see boxplot for each error metric  
# ggplot(resl, aes(metric, value)) + 
#   geom_boxplot() + 
#   facet_wrap(~metric, scales = "free")
```


## Discussion 
A short paragraph discussing why you choose the output and performance measures that you did and some thoughts (1-2 sentences) on what your calibration and post-calibration uncertainty analysis tells you

